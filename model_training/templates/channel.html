
<!DOCTYPE html>
<html>
<head>
    <title>{{ channel_name }} - Chat Messages</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="container">
        <h1>{{ channel_name }} - Chat Messages</h1>
        <a href="/" class="back-link">‚Üê Back to Home</a>
        
        <div class="card">
            <h2>Current Batch of Messages</h2>
            <div class="batch-controls">
                <form action="/refresh_batch" method="post" class="refresh-form">
                    <input type="hidden" name="channel_name" value="{{ channel_name }}">
                    <button type="submit">Refresh Batch</button>
                </form>
            </div>
            
            <div class="message-list">
                {% for message in messages %}
                <div class="message-item">
                    <div class="message-header">
                        <span class="username">{{ message.username }}</span>
                    </div>
                    <div class="message-content">{{ message.message }}</div>
                </div>
                {% endfor %}
            </div>
            
            <form action="/label_batch" method="post" class="batch-label-form">
                <input type="hidden" name="channel_name" value="{{ channel_name }}">
                <input type="hidden" name="batch_id" value="{{ batch_id }}">
                
                <div class="batch-sentiment">
                    <h3>Rate the overall sentiment of this batch:</h3>
                    <div class="sentiment-range-container">
                        <span class="sentiment-label negative">Very Toxic (0.0)</span>
                        <input type="range" id="batch_sentiment" name="batch_sentiment" 
                            min="0" max="1" step="0.01" value="0.5" class="sentiment-range">
                        <span class="sentiment-label positive">Very Positive (1.0)</span>
                    </div>
                    <div class="sentiment-value-display">
                        Current value: <span id="sentiment_value">0.50</span>
                        <div class="sentiment-description" id="sentiment_description">Neutral</div>
                    </div>
                </div>
                
                <button type="submit" class="submit-batch">Save Batch Rating</button>
            </form>
        </div>
        
        <div class="card">
            <h2>Previously Rated Batches</h2>
            <div class="batches-list">
                {% if batches %}
                    {% for batch in batches %}
                    <div class="batch-item">
                        <div class="batch-header">
                            <span class="batch-timestamp">{{ batch.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                            <span class="batch-count">{{ batch.messages|length }} messages</span>
                            <span class="batch-sentiment sentiment-label 
                                {% if batch.sentiment_score < 0.4 %}negative
                                {% elif batch.sentiment_score > 0.6 %}positive
                                {% else %}neutral{% endif %}">
                                Score: {{ "%.2f"|format(batch.sentiment_score) }}
                            </span>
                        </div>
                        <div class="batch-messages-preview">
                            {% for message in batch.messages[:3] %}
                            <div class="message-preview">
                                <span class="username">{{ message.username }}:</span>
                                <span class="message-text">{{ message.message }}</span>
                            </div>
                            {% endfor %}
                            {% if batch.messages|length > 3 %}
                            <div class="message-more">
                                + {{ batch.messages|length - 3 }} more messages
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-batches">No rated batches yet.</div>
                {% endif %}
            </div>
        </div>
        
        {% if model_trained %}
        <div class="card">
            <h2>Predicted Sentiments</h2>
            <button id="predictButton">Predict Sentiment for Current Batch</button>
            <div id="predictions"></div>
        </div>
        {% endif %}
        
    </div>
    
    <script>
        // Update sentiment value display as slider moves
        const sentimentSlider = document.getElementById('batch_sentiment');
        const sentimentValue = document.getElementById('sentiment_value');
        const sentimentDescription = document.getElementById('sentiment_description');
        
        sentimentSlider.addEventListener('input', function() {
            const value = parseFloat(this.value).toFixed(2);
            sentimentValue.textContent = value;
            
            // Update description based on value
            if (value < 0.25) {
                sentimentDescription.textContent = 'Very Toxic';
                sentimentDescription.className = 'sentiment-description very-negative';
            } else if (value < 0.40) {
                sentimentDescription.textContent = 'Negative';
                sentimentDescription.className = 'sentiment-description negative';
            } else if (value < 0.60) {
                sentimentDescription.textContent = 'Neutral';
                sentimentDescription.className = 'sentiment-description neutral';
            } else if (value < 0.75) {
                sentimentDescription.textContent = 'Positive';
                sentimentDescription.className = 'sentiment-description positive';
            } else {
                sentimentDescription.textContent = 'Very Positive';
                sentimentDescription.className = 'sentiment-description very-positive';
            }
        });
        
        {% if model_trained %}
        // Prediction functionality
        document.getElementById('predictButton').addEventListener('click', async function() {
            const response = await fetch('/predict_batch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    channel_name: '{{ channel_name }}',
                    batch_id: '{{ batch_id }}'
                })
            });
            
            if (response.ok) {
                const prediction = await response.json();
                const predictionsDiv = document.getElementById('predictions');
                predictionsDiv.innerHTML = '';
                
                // Display overall batch prediction
                const batchPrediction = document.createElement('div');
                batchPrediction.className = 'batch-prediction';
                
                // Create colored indicator based on sentiment value
                const sentimentValue = parseFloat(prediction.average_sentiment);
                let sentimentClass = 'neutral';
                if (sentimentValue < 0.4) sentimentClass = 'negative';
                else if (sentimentValue > 0.6) sentimentClass = 'positive';
                
                batchPrediction.innerHTML = `
                    <h3>Predicted Batch Sentiment:</h3>
                    <div class="sentiment-label ${sentimentClass}">
                        ${sentimentValue.toFixed(2)} - 
                        ${sentimentValue < 0.25 ? 'Very Toxic' : 
                          sentimentValue < 0.4 ? 'Negative' : 
                          sentimentValue < 0.6 ? 'Neutral' : 
                          sentimentValue < 0.75 ? 'Positive' : 'Very Positive'}
                    </div>
                `;
                
                predictionsDiv.appendChild(batchPrediction);
                
                // Display individual message predictions
                const messagesList = document.createElement('div');
                messagesList.className = 'messages-predictions';
                messagesList.innerHTML = '<h3>Individual Message Predictions:</h3>';
                
                prediction.messages.forEach(msg => {
                    const msgClass = msg.predicted_sentiment < 0.4 ? 'negative' : 
                                    msg.predicted_sentiment > 0.6 ? 'positive' : 'neutral';
                    
                    messagesList.innerHTML += `
                        <div class="message-prediction">
                            <span class="username">${msg.username}:</span>
                            <span class="message-text">${msg.message}</span>
                            <span class="sentiment-label ${msgClass}">
                                ${msg.predicted_sentiment.toFixed(2)}
                            </span>
                        </div>
                    `;
                });
                
                predictionsDiv.appendChild(messagesList);
            }
        });
        {% endif %}
    </script>
</body>
</html>
        